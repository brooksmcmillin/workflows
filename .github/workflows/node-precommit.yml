# Reusable Node.js Pre-commit Workflow
# Standard pre-commit checks for Node.js projects including linting, formatting,
# type checking, testing, building, and security scans.
#
# Usage:
#   jobs:
#     precommit:
#       uses: brooksmcmillin/workflows/.github/workflows/node-precommit.yml@main
#       with:
#         node-version: '22'
#       secrets:
#         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

name: Node Pre-commit

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use for checks'
        type: string
        default: '22'
      # Feature flags
      run-lint:
        description: 'Run linting checks'
        type: boolean
        default: true
      run-format:
        description: 'Run format checks'
        type: boolean
        default: true
      run-type-check:
        description: 'Run TypeScript type checking'
        type: boolean
        default: false
      run-tests:
        description: 'Run tests'
        type: boolean
        default: true
      run-build:
        description: 'Run build'
        type: boolean
        default: true
      run-security:
        description: 'Run security checks (npm audit)'
        type: boolean
        default: true
      # Command customization
      lint-command:
        description: 'Custom lint command'
        type: string
        default: 'npm run lint'
      format-command:
        description: 'Custom format check command'
        type: string
        default: 'npm run format:check'
      type-check-command:
        description: 'Custom type check command'
        type: string
        default: 'npx tsc --noEmit'
      test-command:
        description: 'Custom test command'
        type: string
        default: 'npm test'
      build-command:
        description: 'Custom build command'
        type: string
        default: 'npm run build'
      # Additional options
      fail-fast:
        description: 'Fail immediately on first error'
        type: boolean
        default: true
      upload-coverage:
        description: 'Upload coverage to Codecov'
        type: boolean
        default: true
    secrets:
      CODECOV_TOKEN:
        description: 'Codecov token for coverage upload'
        required: false

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: ${{ inputs.run-lint }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: ${{ inputs.lint-command }}

  format:
    name: Format
    runs-on: ubuntu-latest
    if: ${{ inputs.run-format }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run format check
        run: ${{ inputs.format-command }}

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    if: ${{ inputs.run-type-check }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: ${{ inputs.type-check-command }}

  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ inputs.run-tests }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: ${{ inputs.test-command }}

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload-coverage }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

  build:
    name: Build
    runs-on: ubuntu-latest
    if: ${{ inputs.run-build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: ${{ inputs.build-command }}

  security:
    name: Security
    runs-on: ubuntu-latest
    if: ${{ inputs.run-security }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --production --json > npm-audit.json || true
          npm audit --production || true

          HIGH_VULN=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULN=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')

          if [ "$CRITICAL_VULN" -gt 0 ]; then
            echo "::error::Found $CRITICAL_VULN critical vulnerabilities"
            exit 1
          elif [ "$HIGH_VULN" -gt 0 ]; then
            echo "::warning::Found $HIGH_VULN high vulnerabilities"
          else
            echo "No high or critical vulnerabilities found"
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: npm-audit.json
          retention-days: 30

  summary:
    name: Pre-commit Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, format, type-check, test, build, security]
    steps:
      - name: Check results
        run: |
          echo "## Pre-commit Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Lint
          if [ "${{ inputs.run-lint }}" == "true" ]; then
            if [ "${{ needs.lint.result }}" == "success" ]; then
              echo "| Lint | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.lint.result }}" == "skipped" ]; then
              echo "| Lint | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Lint | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Lint | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          # Format
          if [ "${{ inputs.run-format }}" == "true" ]; then
            if [ "${{ needs.format.result }}" == "success" ]; then
              echo "| Format | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.format.result }}" == "skipped" ]; then
              echo "| Format | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Format | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Format | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          # Type Check
          if [ "${{ inputs.run-type-check }}" == "true" ]; then
            if [ "${{ needs.type-check.result }}" == "success" ]; then
              echo "| Type Check | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.type-check.result }}" == "skipped" ]; then
              echo "| Type Check | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Type Check | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Type Check | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          # Test
          if [ "${{ inputs.run-tests }}" == "true" ]; then
            if [ "${{ needs.test.result }}" == "success" ]; then
              echo "| Test | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test.result }}" == "skipped" ]; then
              echo "| Test | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Test | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Test | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          # Build
          if [ "${{ inputs.run-build }}" == "true" ]; then
            if [ "${{ needs.build.result }}" == "success" ]; then
              echo "| Build | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build.result }}" == "skipped" ]; then
              echo "| Build | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Build | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Build | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          # Security
          if [ "${{ inputs.run-security }}" == "true" ]; then
            if [ "${{ needs.security.result }}" == "success" ]; then
              echo "| Security | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.security.result }}" == "skipped" ]; then
              echo "| Security | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Security | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Security | :fast_forward: Disabled |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any check failed
        if: ${{ inputs.fail-fast }}
        run: |
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.format.result }}" == "failure" ] || \
             [ "${{ needs.type-check.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ] || \
             [ "${{ needs.security.result }}" == "failure" ]; then
            echo "One or more checks failed"
            exit 1
          fi
