name: Claude Code Review

on:
  workflow_call:
    inputs:
      file-patterns:
        description: 'File patterns to trigger review (newline separated)'
        type: string
        default: |
          **/*.py
      pr-types:
        description: 'PR types to trigger on (JSON array)'
        type: string
        default: '["opened", "synchronize", "reopened"]'
      focus-areas:
        description: 'Custom focus areas for the review'
        type: string
        default: |
          **Code Quality & Correctness:**
          - Logic errors or bugs
          - Edge cases not handled
          - Potential runtime errors
          - Code that doesn't match its documentation

          **Best Practices:**
          - Code organization and structure
          - Error handling
          - Performance issues
          - Maintainability concerns
      claude-args:
        description: 'Additional arguments to pass to Claude Code'
        type: string
        default: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'OAuth token for Claude Code'
        required: true

# Note: file-patterns and pr-types inputs are provided for the calling workflow
# to use in path filters and event triggers. They cannot be enforced here.

concurrency:
  group: claude-code-review-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request focusing on:

            ${{ inputs.focus-areas }}

            Use the repository's CLAUDE.md for guidance on the codebase architecture.

            Be specific about any issues found, including file paths and line numbers.
            If the code looks good, briefly confirm the changes are sound.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: ${{ inputs.claude-args }}
