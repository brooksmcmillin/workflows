name: Node Security

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version for security scanning'
        type: string
        default: '22'
      run-npm-audit:
        description: 'Run npm audit'
        type: boolean
        default: true
      run-codeql:
        description: 'Run CodeQL analysis'
        type: boolean
        default: true
      run-trivy:
        description: 'Run Trivy filesystem scan'
        type: boolean
        default: true
      run-license-check:
        description: 'Run license compliance check'
        type: boolean
        default: true
      allowed-licenses:
        description: 'Allowed licenses for license check'
        type: string
        default: 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;CC-BY-3.0;CC-BY-4.0;Unlicense;Python-2.0'
      fail-on-critical:
        description: 'Fail if critical vulnerabilities are found'
        type: boolean
        default: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-basics:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: NPM Audit
        if: ${{ inputs.run-npm-audit }}
        id: npm-audit
        run: |
          echo "### NPM Audit Results ###" > security-report.txt
          npm audit --production --json > npm-audit.json || true
          npm audit --production >> security-report.txt 2>&1 || true

          HIGH_VULN=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULN=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')

          echo "high_count=$HIGH_VULN" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_VULN" >> $GITHUB_OUTPUT

          if [ "$CRITICAL_VULN" -gt 0 ]; then
            echo "Found $CRITICAL_VULN critical vulnerabilities!"
            if [ "${{ inputs.fail-on-critical }}" == "true" ]; then
              exit 1
            fi
          elif [ "$HIGH_VULN" -gt 0 ]; then
            echo "Found $HIGH_VULN high vulnerabilities"
          else
            echo "No high or critical vulnerabilities found"
          fi

      - name: License Check
        if: ${{ inputs.run-license-check }}
        continue-on-error: true
        run: |
          npx license-checker-rseidelsohn --production --summary --excludePrivatePackages >> security-report.txt
          echo -e "\n### Non-Standard Licenses ###" >> security-report.txt
          npx license-checker-rseidelsohn --production --excludePrivatePackages --onlyAllow "${{ inputs.allowed-licenses }}" >> security-report.txt 2>&1 || echo "Some non-standard licenses found" >> security-report.txt

      - name: Secret Detection
        run: |
          echo -e "\n### Secret Detection ###" >> security-report.txt

          patterns=(
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*=.*['\"][^'\"]{20,}['\"]"
            "secret.*=.*['\"][^'\"]{20,}['\"]"
            "token.*=.*['\"][^'\"]{20,}['\"]"
            "private[_-]?key"
            "BEGIN.*PRIVATE KEY"
          )

          found_secrets=0
          for pattern in "${patterns[@]}"; do
            if grep -r -E "$pattern" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.test.js" --exclude="*.spec.js" . 2>/dev/null; then
              echo "Potential secret found with pattern: $pattern" >> security-report.txt
              found_secrets=1
            fi
          done

          if [ $found_secrets -eq 0 ]; then
            echo "No obvious secrets detected" >> security-report.txt
          fi

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            security-report.txt
            npm-audit.json
          retention-days: 30

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: ${{ inputs.run-codeql }}
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.run-trivy }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          output: 'trivy-report.txt'

      - name: Run Trivy in SARIF mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: trivy-report.txt

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-basics, codeql, trivy]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Create summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Basics | ${{ needs.security-basics.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Scan | ${{ needs.trivy.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## Security Scan Results

            | Check | Status |
            |-------|--------|
            | Security Basics | ${{ needs.security-basics.result }} |
            | CodeQL Analysis | ${{ needs.codeql.result }} |
            | Trivy Scan | ${{ needs.trivy.result }} |

            View the [full security report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
