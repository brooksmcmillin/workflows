name: Ansible CI

on:
  workflow_call:
    inputs:
      ansible-version:
        description: 'Ansible version to install (e.g., "latest", "2.16", "2.17")'
        type: string
        default: 'latest'
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.12'
      run-yamllint:
        description: 'Run yamllint on YAML files'
        type: boolean
        default: true
      run-ansible-lint:
        description: 'Run ansible-lint'
        type: boolean
        default: true
      run-syntax-check:
        description: 'Run ansible-playbook --syntax-check on all playbooks'
        type: boolean
        default: true
      playbook-paths:
        description: 'Space-separated list of playbook files to syntax check (defaults to *.yaml in root)'
        type: string
        default: ''
      lint-config:
        description: 'Path to ansible-lint config file'
        type: string
        default: ''
      yamllint-config:
        description: 'Path to yamllint config file'
        type: string
        default: ''

concurrency:
  group: ansible-ci-${{ github.workflow }}-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ inputs.run-yamllint }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install yamllint
        run: pip install yamllint

      - name: Create default yamllint config
        if: ${{ inputs.yamllint-config == '' }}
        run: |
          cat > .yamllint.yml << 'EOF'
          extends: default
          rules:
            line-length:
              max: 160
              allow-non-breakable-words: true
              allow-non-breakable-inline-mappings: true
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
            comments:
              min-spaces-from-content: 1
            braces:
              min-spaces-inside: 0
              max-spaces-inside: 1
          EOF

      - name: Run yamllint
        env:
          YAMLLINT_CONFIG: ${{ inputs.yamllint-config }}
        run: |
          if [ -n "$YAMLLINT_CONFIG" ]; then
            yamllint -c "$YAMLLINT_CONFIG" .
          else
            yamllint -c .yamllint.yml .
          fi

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ inputs.run-ansible-lint }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install ansible-lint
        env:
          ANSIBLE_VERSION: ${{ inputs.ansible-version }}
        run: |
          if [ "$ANSIBLE_VERSION" = "latest" ]; then
            pip install ansible ansible-lint
          else
            pip install "ansible-core~=${ANSIBLE_VERSION}.0" ansible-lint
          fi

      - name: Install required collections
        run: |
          if [ -f requirements.yml ]; then
            ansible-galaxy collection install -r requirements.yml
          fi
          # Always install community.general for common modules like pacman
          ansible-galaxy collection install community.general

      - name: Run ansible-lint
        env:
          LINT_CONFIG: ${{ inputs.lint-config }}
        run: |
          if [ -n "$LINT_CONFIG" ]; then
            ansible-lint -c "$LINT_CONFIG"
          else
            ansible-lint
          fi

  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ inputs.run-syntax-check }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Ansible
        env:
          ANSIBLE_VERSION: ${{ inputs.ansible-version }}
        run: |
          if [ "$ANSIBLE_VERSION" = "latest" ]; then
            pip install ansible
          else
            pip install "ansible-core~=${ANSIBLE_VERSION}.0"
          fi

      - name: Install required collections
        run: |
          if [ -f requirements.yml ]; then
            ansible-galaxy collection install -r requirements.yml
          fi
          ansible-galaxy collection install community.general

      - name: Find and check playbooks
        env:
          PLAYBOOK_PATHS: ${{ inputs.playbook-paths }}
        run: |
          PLAYBOOKS="$PLAYBOOK_PATHS"
          if [ -z "$PLAYBOOKS" ]; then
            # Find all yaml files in root that look like playbooks (contain 'hosts:')
            PLAYBOOKS=$(grep -l "^- .*hosts:" *.yaml *.yml 2>/dev/null || true)
          fi

          if [ -z "$PLAYBOOKS" ]; then
            echo "No playbooks found to check"
            exit 0
          fi

          echo "Checking playbooks: $PLAYBOOKS"
          for playbook in $PLAYBOOKS; do
            echo "Checking $playbook..."
            ansible-playbook --syntax-check -i localhost, "$playbook"
          done
